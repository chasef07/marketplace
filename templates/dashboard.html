{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>üè™ Marketplace Dashboard</h2>
    
    {% if not current_user.is_authenticated %}
    <div class="card">
        <h3>Welcome to the AI Marketplace!</h3>
        <p>Please <a href="{{ url_for('auth.login') }}">login</a> or <a href="{{ url_for('auth.register') }}">register</a> to create listings and negotiate with AI buyers.</p>
    </div>
    {% endif %}
    
    {% if current_user.is_authenticated and user_items %}
    <div class="section">
        <h3>üì¶ Your Listings ({{ user_items|length }})</h3>
        <div class="items-grid">
            {% for item in user_items %}
            <div class="card item-card">
                {% if item.image_path %}
                <img src="{{ url_for('static', filename='uploads/' + item.image_path) }}" alt="{{ item.name }}" class="item-image">
                {% endif %}
                <h4>{{ item.name }}</h4>
                <p><strong>Price:</strong> ${{ item.starting_price }} (min: ${{ item.min_price }})</p>
                <p><strong>Condition:</strong> {{ item.condition.title() }}</p>
                <p>{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</p>
                <p><small>Listed {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
                
                {% if item.is_sold %}
                <span class="badge sold">SOLD</span>
                {% else %}
                <form method="POST" action="{{ url_for('main.delete_item', item_id=item.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?')">Delete</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if current_user.is_authenticated and active_negotiations %}
    <div class="section">
        <h3>ü§ù Active Negotiations ({{ active_negotiations|length }})</h3>
        {% for negotiation in active_negotiations %}
        <div class="card">
            <h4>{{ negotiation.item.name }}</h4>
            <p><strong>With:</strong> 
                {% if negotiation.buyer_id %}
                {{ negotiation.buyer.username }}
                {% else %}
                AI Buyer
                {% endif %}
            </p>
            <p><strong>Current Offer:</strong> ${{ negotiation.current_offer }}</p>
            <p><strong>Round:</strong> {{ negotiation.round_number }}/{{ negotiation.max_rounds }}</p>
            <p><strong>Status:</strong> {{ negotiation.status.value.replace('_', ' ').title() }}</p>
            <a href="{{ url_for('main.view_negotiation', negotiation_id=negotiation.id) }}" class="btn btn-primary">View Details</a>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="section">
        <h3>üõçÔ∏è Available Items ({{ items|length }})</h3>
        
        {% if not items %}
        <div class="card">
            <p>No items available at the moment. {% if current_user.is_authenticated %}<a href="{{ url_for('main.create_listing') }}">Create the first listing!</a>{% endif %}</p>
        </div>
        {% else %}
        <div class="items-grid">
            {% for item in items %}
            <div class="card item-card">
                {% if item.image_path %}
                <img src="{{ url_for('static', filename='uploads/' + item.image_path) }}" alt="{{ item.name }}" class="item-image">
                {% endif %}
                <h4>{{ item.name }}</h4>
                <p><strong>Price:</strong> ${{ item.starting_price }}</p>
                <p><strong>Condition:</strong> {{ item.condition.title() }}</p>
                <p><strong>Type:</strong> {{ item.furniture_type.value.replace('_', ' ').title() }}</p>
                <p>{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</p>
                <p><small>By {{ item.owner.username }} ‚Ä¢ {{ item.created_at.strftime('%Y-%m-%d') }}</small></p>
                
                <div class="item-actions">
                    <a href="{{ url_for('main.view_item', item_id=item.id) }}" class="btn btn-primary btn-sm">View Details</a>
                    {% if current_user.is_authenticated and current_user.id != item.user_id %}
                    <a href="{{ url_for('main.negotiate_page', item_id=item.id) }}" class="btn btn-success btn-sm">Negotiate</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<style>
.items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.item-card {
    position: relative;
}

.item-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 10px;
}

.item-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge.sold {
    background: #dc3545;
    color: white;
}

.section {
    margin: 30px 0;
}
</style>
{% endblock %}