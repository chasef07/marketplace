{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
<h2>üìù Create New Furniture Listing</h2>

<!-- AI Analysis Results Section (Hidden by default) -->
<div id="ai-analysis-section" class="ai-analysis-card" style="display: none;">
    <h3>ü§ñ AI Analysis Results</h3>
    <div id="analysis-content"></div>
    <button type="button" id="use-ai-suggestions" class="btn btn-primary">Use AI Suggestions</button>
    <button type="button" id="dismiss-analysis" class="btn btn-secondary">Keep My Input</button>
</div>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    
    <div class="form-group">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control", placeholder="e.g. Vintage Leather Couch") }}
        {% for error in form.name.errors %}
            <div class="error">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="form-group">
        {{ form.furniture_type.label(class="form-label") }}
        {{ form.furniture_type(class="form-control") }}
        {% for error in form.furniture_type.errors %}
            <div class="error">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="form-row">
        <div class="form-group half-width">
            {{ form.starting_price.label(class="form-label") }}
            {{ form.starting_price(class="form-control", placeholder="500.00", id="starting_price") }}
            {% for error in form.starting_price.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="form-group half-width">
            {{ form.min_price.label(class="form-label") }}
            {{ form.min_price(class="form-control", placeholder="300.00", id="min_price") }}
            {% for error in form.min_price.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
    </div>

    <div class="form-group">
        {{ form.condition.label(class="form-label") }}
        {{ form.condition(class="form-control") }}
        {% for error in form.condition.errors %}
            <div class="error">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="form-group">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows="4", placeholder="Describe your furniture item...") }}
        {% for error in form.description.errors %}
            <div class="error">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="form-group">
        {{ form.image.label(class="form-label") }}
        {{ form.image(class="form-control", accept="image/*", id="image-upload") }}
        {% for error in form.image.errors %}
            <div class="error">{{ error }}</div>
        {% endfor %}
        <small class="form-text">Optional. JPG, PNG only, max 5MB. AI will analyze your photo!</small>
        <div id="upload-status" class="upload-status"></div>
        <div id="image-preview" class="image-preview"></div>
    </div>

    <div class="form-group">
        {{ form.submit(class="btn btn-success") }}
        <a href="{{ url_for('main.homepage') }}" class="btn">Cancel</a>
    </div>
</form>

<style>
.form-row {
    display: flex;
    gap: 15px;
}

.half-width {
    flex: 1;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.form-text {
    color: #666;
    font-size: 0.85em;
}

.error {
    color: #dc3545;
    font-size: 0.85em;
    margin-top: 5px;
}

/* AI Analysis Styles */
.ai-analysis-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.ai-analysis-card h3 {
    margin-top: 0;
    margin-bottom: 15px;
}

.analysis-item {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}

.analysis-item strong {
    display: block;
    margin-bottom: 5px;
}

.upload-status {
    margin-top: 10px;
    padding: 10px;
    border-radius: 5px;
    display: none;
}

.upload-status.loading {
    background: #e3f2fd;
    color: #1976d2;
    display: block;
}

.upload-status.success {
    background: #e8f5e8;
    color: #2e7d32;
    display: block;
}

.upload-status.error {
    background: #ffebee;
    color: #c62828;
    display: block;
}

.image-preview {
    margin-top: 15px;
}

.image-preview img {
    max-width: 300px;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.pricing-item {
    background: rgba(255,255,255,0.15);
    padding: 8px;
    border-radius: 5px;
    text-align: center;
}

.pricing-item .price {
    font-size: 1.2em;
    font-weight: bold;
}

.pricing-item .label {
    font-size: 0.9em;
    opacity: 0.9;
}
</style>

<script>
let currentAnalysis = null;

// Auto-calculate minimum price as 60% of starting price
document.getElementById('starting_price').addEventListener('input', function() {
    const price = parseFloat(this.value);
    const minPriceField = document.getElementById('min_price');
    if (price && !minPriceField.value) {
        minPriceField.value = (price * 0.6).toFixed(2);
    }
});

// Image upload and analysis
document.getElementById('image-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Show image preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
    };
    reader.readAsDataURL(file);
    
    // Start AI analysis
    analyzeImage(file);
});

function analyzeImage(file) {
    const statusDiv = document.getElementById('upload-status');
    statusDiv.className = 'upload-status loading';
    statusDiv.textContent = 'ü§ñ Analyzing your furniture image...';
    
    const formData = new FormData();
    formData.append('image', file);
    
    fetch('/api/analyze-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentAnalysis = data;
            showAnalysisResults(data);
            statusDiv.className = 'upload-status success';
            statusDiv.textContent = '‚úÖ AI analysis complete! Check the suggestions below.';
        } else {
            statusDiv.className = 'upload-status error';
            statusDiv.textContent = `‚ùå Analysis failed: ${data.error}`;
        }
    })
    .catch(error => {
        statusDiv.className = 'upload-status error';
        statusDiv.textContent = `‚ùå Error: ${error.message}`;
    });
}

function showAnalysisResults(data) {
    const analysisSection = document.getElementById('ai-analysis-section');
    const analysisContent = document.getElementById('analysis-content');
    
    const analysis = data.analysis;
    const pricing = data.pricing;
    
    analysisContent.innerHTML = `
        <div class="analysis-item">
            <strong>üéØ Detected Item:</strong> ${analysis.furniture_type}
        </div>
        <div class="analysis-item">
            <strong>üè∑Ô∏è Brand:</strong> ${analysis.brand}
        </div>
        <div class="analysis-item">
            <strong>üé® Style:</strong> ${analysis.style} ‚Ä¢ ${analysis.color} ${analysis.material}
        </div>
        <div class="analysis-item">
            <strong>‚≠ê Condition:</strong> ${analysis.condition_score}/10 - ${analysis.condition_notes}
        </div>
        <div class="analysis-item">
            <strong>üìè Size:</strong> ${analysis.estimated_dimensions}
        </div>
        <div class="analysis-item">
            <strong>üí∞ Pricing Suggestions:</strong>
            <div class="pricing-grid">
                <div class="pricing-item">
                    <div class="price">$${pricing.quick_sale_price}</div>
                    <div class="label">Quick Sale</div>
                </div>
                <div class="pricing-item">
                    <div class="price">$${pricing.market_price}</div>
                    <div class="label">Market Rate</div>
                </div>
                <div class="pricing-item">
                    <div class="price">$${pricing.premium_price}</div>
                    <div class="label">Premium</div>
                </div>
            </div>
        </div>
        <div class="analysis-item">
            <strong>üìù Suggested Title:</strong> ${data.listing.title}
        </div>
    `;
    
    analysisSection.style.display = 'block';
}

// Use AI suggestions button
document.getElementById('use-ai-suggestions').addEventListener('click', function() {
    if (!currentAnalysis) return;
    
    const data = currentAnalysis;
    
    // Fill form fields with AI suggestions
    document.getElementById('name').value = data.listing.title;
    document.getElementById('description').value = data.listing.description;
    document.getElementById('furniture_type').value = data.listing.furniture_type;
    document.getElementById('starting_price').value = data.pricing.suggested_starting_price;
    document.getElementById('min_price').value = data.pricing.suggested_min_price;
    
    // Hide analysis section
    document.getElementById('ai-analysis-section').style.display = 'none';
    
    // Show success message
    const statusDiv = document.getElementById('upload-status');
    statusDiv.className = 'upload-status success';
    statusDiv.textContent = 'üéØ AI suggestions applied to your listing!';
});

// Dismiss analysis button
document.getElementById('dismiss-analysis').addEventListener('click', function() {
    document.getElementById('ai-analysis-section').style.display = 'none';
});
</script>
{% endblock %}